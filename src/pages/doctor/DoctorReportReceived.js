import React from 'react';import {Redirect} from "react-router-dom";import Authenticate from "../../components/operation/Authenticate";import Column from "../../components/layout/Column";import Grid from "../../components/layout/Grid";import Row from "../../components/layout/Row";import UserType from "../../components/operation/UserType";import Container from "../../components/layout/Container";import Padding from "../../components/basics/Padding";import backend from "../../apis/backend";import HubReportCard from "../../components/card/HubReportCard";import UserMenu from "../UserMenu";import {connect} from "react-redux";import {getUser} from "../../redux/actions/registration";import ReportDimmer from "../../components/basics/ReportDimmer";import Dimmer from "../../components/basics/Dimmer";import Field from "../../components/basics/Field";import EmptyButton from "../../components/basics/EmptyButton";import MultiImageField from "../../components/basics/MultiImageField";import TextField from "../../components/basics/TextField";class DoctorReportReceived extends React.Component {    state = {        files: [],        reports: [],        searchValue: "",        isReportLoaded: false,        reportSelected: undefined,        isReportActive: false,        isViewAction: false,        selectedReceivers: [],        descriptionValue: "",        infoValue: "",        reloadPage: false,        reportImages: [],        sender: undefined,    };    constructor(props) {        super(props);        this.props.getUser();    }    componentDidMount = async () => {        if (this.props.user === undefined) {            return undefined;        }        const url = "/user/" + this.props.user.id + "/fetch_reports_hub_by_sender/";        const response = await backend.get(url);        if (response.data.status_code === 200) {            this.setState({reports: response.data.data.reports});        }    };    pushFilesSelected = (files) => {        this.setState({files: files})    };    searchAction = async () => {        const url = "/user/" + this.props.user.id + "/fetch_reports_hub_by_sender/";        const response = await backend.get(url);        if (response.data.status_code === 200) {            this.setState({reports: response.data.data.reports});        }    };    renderSearchBar = () => {        return (            <div>                <Row>                    <Column size={3}/>                    <Column size={10}>                        <h2 className="ui header">                            <i className="search icon"/>                            <div className="content">                                Find Report                            </div>                        </h2>                    </Column>                    <Column size={3}/>                </Row>                <Padding repeat={1}/>                <Row>                    <Column size={3}/>                    <Column size={10}>                        <div className="ui action input" style={{width: "100%", height: "40px"}}>                            <input                                type="text"                                placeholder="from ..."                                onChange={(e) => {                                    this.setState({searchValue: e.target.value})                                }}                                value={this.state.searchValue}                                onKeyDown={e => {                                    if (e.keyCode === 13)                                        this.searchAction()                                }}                            />                            <button className="ui button" onClick={this.searchAction}>Search</button>                        </div>                    </Column>                    <Column size={3}/>                </Row>            </div>        );    };    renderPageContent = () => {        return (            <Container style={{width: "96%", marginLeft: "2%"}}>                <Grid>                    <Padding repeat={7}/>                    <Row>                        <Column size={1}/>                        <Column size={14}>                            {this.renderSearchBar()}                            <Padding repeat={1}/>                            {this.renderReports()}                            {this.renderReplayReportDimmer()}                        </Column>                        <Column size={1}/>                    </Row>                    <Padding repeat={3}/>                </Grid>            </Container>        );    };    sendReplayAction = async () => {        const formData = new FormData();        formData.append("photo_size", this.state.files.length);        for (var i = 1; i < this.state.files.length + 1; i++) {            formData.append("photo" + i, this.state.files[i - 1]);        }        formData.append("title", this.state.title);        formData.append("description", this.state.description);        formData.append("patient", this.state.reportSelected.patient.id);        formData.append("doctor", this.props.user.id);        const url = "user/" + this.props.user.id + "/create_report/";        const response = await backend.post(url, formData, {            headers: {                'Content-Type': 'multipart/form-data'            }        });        if (response.data.status_code === 200) {            this.setState({reloadPage: true});        }        const report = response.data.data.report;        const formData2 = new FormData();        const receiver_list = [];        receiver_list.push(this.state.reportSelected.patient.id);        formData2.append("receiver_list", receiver_list);        formData2.append("title", "Replay report from Dr." + this.props.user.first_name);        formData2.append("sender", this.props.user.id);        formData2.append("msg", "Replay report from Dr." + this.props.user.first_name);        formData2.append("report", report.id);        const url2 = "user/" + this.props.user.id + "/send_report/";        const response2 = await backend.post(url2, formData2, {            headers: {                'Content-Type': 'multipart/form-data'            }        });        if (response2.data.status_code === 200) {            this.setState({reloadPage: true});        }    };    renderReplayReportDimmer = () => {        if (this.state.reportSelected === undefined) {            return <div/>;        }        return (            <Dimmer                active={this.state.isReportActive && !this.state.isViewAction}                reset={                    (value) => {                        this.setState({isReportActive: value});                    }}                width={80}            >                <div className="ui field" style={{textAlign: "left", fontSize: "1.4em"}}>                    <label><i className="paper plane outline icon"/>Replay Report</label>                </div>                <Field>                    <label style={{textAlign: "left"}}>Patient:</label>                    <label className="ui teal image label" style={{maxWidth: "fit-content"}}>                        <i className="id badge icon"/>                        {this.state.reportSelected.patient.first_name} {this.state.reportSelected.patient.last_name}                        <div className="detail">{this.state.reportSelected.patient.code}</div>                    </label>                </Field>                <Field>                    <label style={{textAlign: "left"}}>Images:</label>                    <MultiImageField pushImages={this.pushFilesSelected}/>                </Field>                <Field>                    <label style={{textAlign: "left"}}>Info</label>                    <TextField                        value={this.state.infoValue}                        autoComplete={"false"}                        style={{fontSize: "1.1em"}}                        onChange={                            (e) => {                                this.setState({infoValue: e.target.value})                            }                        }                    />                </Field>                <Field>                    <label style={{textAlign: "left"}}>Description</label>                    <textarea                        value={this.state.descriptionValue}                        autoComplete={"false"}                        style={{fontSize: "1.1em"}}                        onChange={                            (e) => {                                this.setState({descriptionValue: e.target.value})                            }                        }                    />                </Field>                <div className="ui field">                    <EmptyButton text="Send" style={{width: "200px"}}                                 onClick={this.sendReplayAction}/>                </div>            </Dimmer>        );    };    renderReports = () => {        if (this.state.reports.length === 0) {            return (                <div style={{marginTop: "400px"}}>                    <div className="ui large active text loader">Loading</div>                </div>            );        }        return this.state.reports.map((report, key) => {            return (                <HubReportCard                    key={key}                    report={report}                    userId={this.props.user.id}                    sendButtonText="Replay On Report"                    sendButton={                        () => {                            this.setState({                                reportSelected: report.report,                                isReportActive: true,                                isViewAction: false,                                sender: report.sender                            });                        }}                    viewButton={                        (images) => {                            const imagesSrc = images.map(item => {                                return item.image;                            });                            this.setState({                                reportSelected: report.report,                                isReportActive: true,                                isViewAction: true,                                reportImages: imagesSrc                            });                        }}                />            );        });    };    renderPage = () => {        return (            <UserType                doctor={                    <div style={{backgroundColor: "#f1f2f5", height: "100%"}}>                        <UserMenu/>                        {this.renderPageContent()}                        <ReportDimmer                            active={this.state.isReportActive && this.state.isViewAction}                            reset={                                (value) => {                                    this.setState({isReportActive: value});                                }}                            report={this.state.reportSelected}                            images={this.state.reportImages}                        />                    </div>                }                supervisor={<Redirect to="/"/>}                patient={<Redirect to="/"/>}                developer={<Redirect to="/"/>}                none={<Redirect to="/"/>}            />        );    };    render() {        if (this.state.reloadPage) {            this.setState({                reloadPage: false,                isReportActive: false,                infoValue: "",                descriptionValue: "",            });        }        return (            <Authenticate                AComponent={this.renderPage()}                Dto="/"            />        );    }}const mapStateToProps = state => {    return {user: state.user.user};};export default connect(mapStateToProps, {getUser})(DoctorReportReceived);